
# ログ設計方針

本ドキュメントは、営業オポチュニティマネジメント AIアシスタントシステムのログ設計方針を示す。

---

## 🎯 設計目的

- システム動作状況の可視化
- エラーや例外の追跡
- Slackイベント入力のトレース
- API利用状況の記録
- 将来の監査・トラブル調査に対応可能な設計

---

## ✅ ログ種別と用途

| ログ種別             | ロガー名例 | 用途                                                      |
| -------------------- | ---------- | --------------------------------------------------------- |
| アクセスログ         | app.access | APIリクエストのmethod, path, status, time等を記録         |
| Slackイベントログ    | app.slack  | Slackからの受信イベント内容を記録                         |
| 操作ログ（監査ログ） | app.audit  | オポチュニティ/アクティビティの作成・更新・削除操作を記録 |
| アプリケーションログ | app.app    | 内部処理の進行状況、エラー、例外等を記録                  |

---

## ✅ ログ形式

- JSON形式の構造化ログを推奨
- ログ項目（共通）:

| 項目           | 説明                                          |
| -------------- | --------------------------------------------- |
| timestamp      | タイムスタンプ（ISO8601）                     |
| level          | ログレベル（DEBUG/INFO/WARNING/ERROR）        |
| logger         | ロガー名                                      |
| request_id     | リクエスト単位のUUID                          |
| user_id        | Slack User ID（存在する場合）                 |
| operation_type | 操作種別（create/update/deleteなど）          |
| resource_type  | 対象リソース（opportunity, activity_logなど） |
| resource_id    | リソースID（存在する場合）                    |

---

## ✅ ログ出力先

- **初期構成**: stdout出力（コンテナ/アプリ標準出力）
- **ログ収集基盤導入時**: Loki, CloudWatch Logs, Datadog等に転送対応可能
- ファイル出力運用は行わない（ログ管理基盤前提）

---

## ✅ ログレベル運用ルール

| レベル  | 用途                                              |
| ------- | ------------------------------------------------- |
| DEBUG   | Slack受信詳細、内部変数出力（デフォルトでは無効） |
| INFO    | 操作成功、Slackイベント受信、処理成功             |
| WARNING | 想定外入力、無効データ受信                        |
| ERROR   | 例外、Slack送信失敗、DB操作失敗                   |

---

## ✅ 実装ガイドライン

- FastAPI middlewareでアクセスログ出力
- Slackイベント受信時に `app.slack` で全文JSONログ
- CRUD操作は `app.audit` で「操作種別・対象ID」含むJSONログをINFOレベルで出力
- 全logger共通で `request_id` をコンテキスト情報として持つ（log_context等）
- エラーハンドリングは `app.app` にて例外内容記録

---

## 🚩 注意事項

- ログは個人情報を含まない設計とする（Slack User IDは例外として記録可）
- ログ収集基盤導入時は、JSON構造保持可能なストレージ・ビューワを使用すること
- ログ項目や形式の変更時はこのドキュメントを更新すること

---

## ✅ 設計意図

- 最小構成では stdout出力で簡易運用を実現
- JSON構造化ログにより後からの集計・分析・モニタリングにも対応可能
- ログ種別・用途を明確に区別し、必要に応じてログレベルで抑制/有効化できる設計

---

以上

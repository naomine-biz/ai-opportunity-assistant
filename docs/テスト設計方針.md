
# テスト設計方針

本ドキュメントは、営業オポチュニティマネジメント AIアシスタントシステムのテスト設計方針を示す。

---

## 🎯 設計目的

- API・サービス層・Slack連携処理の動作確認
- 内部ロジックの誤動作防止
- 開発・運用時のリグレッションリスク低減

対象：API層、サービス層、Slack Botイベントハンドラ、スケジューラー  
対象外：UIテスト、外部公開APIのE2Eテスト（該当なし）

---

## ✅ テスト分類と方針

### ① ユニットテスト（単体テスト）

| 対象       | 内容                                                                    |
| ---------- | ----------------------------------------------------------------------- |
| サービス層 | オポチュニティ取得・更新、アクティビティ記録、Slack通知生成等の関数単位 |
| 外部依存   | DB、Slack APIはモック化                                                 |

- pytest + unittest.mock を使用
- 主要ビジネスロジックの動作保証を目的

---

### ② APIテスト（統合テスト）

| 対象                  | 内容                                                                                     |
| --------------------- | ---------------------------------------------------------------------------------------- |
| FastAPIエンドポイント | `/opportunity` CRUD、`/activity_log` POST、`/slack/events` POST、`/notify/progress` POST |

- FastAPIの TestClient を利用
- 実DB or テスト用SQLite + test fixtures で動作確認
- Slack Event API の verification challenge もテスト

---

### ③ E2Eに近いシナリオテスト（軽め）

| 対象              | 内容                                                          |
| ----------------- | ------------------------------------------------------------- |
| Slackイベント処理 | Slackイベント受信 → 内部ロジック呼出 → DB確認                 |
| スケジューラー    | `/notify/progress` 実行 → Slack送信関数が呼ばれたかモック確認 |

- pytest-mock / MagicMock でSlack API呼出spy
- スケジューラーは日時モックで動作確認

---

## ✅ テスト優先度

| 項目                     | 優先度 | 理由                         |
| ------------------------ | ------ | ---------------------------- |
| サービス層ユニットテスト | ⭐⭐⭐⭐   | ビジネスロジック誤動作防止   |
| APIテスト（CRUD系）      | ⭐⭐⭐⭐   | インターフェース正確性保証   |
| Slack Eventテスト        | ⭐⭐⭐    | イベント仕様変更対応         |
| スケジューラーテスト     | ⭐⭐     | 単体では日時モックで確認可能 |
| DBエラー／例外系         | ⭐⭐     | 余裕あれば追加               |

---

## ✅ 実装方針

- pytest ベース
- `tests/` 以下に `/api`, `/services`, `/utils` サブディレクトリ構成
- SQLModelの test_session fixture で rollback 運用
- Slack API等の外部依存はモックで処理

---

## ✅ 設計意図

- 初期段階では「API正確性」と「サービス層ロジック検証」に注力
- Slack連携部分は外部API依存をモックし疎結合化
- CI/CDパイプラインに pytest を組込み可能な構造とする

---

以上

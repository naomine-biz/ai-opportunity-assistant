# アクティブコンテキスト

## 現在の作業焦点

### 現在のフェーズ
- **実装フェーズ**
  - 要件定義完了
  - 技術選定完了
  - アーキテクチャ設計完了
  - API仕様定義完了
  - DB設計完了
  - 各種設計方針文書化完了
  - プロジェクト構造の作成完了
  - 基本モジュールの実装完了
  - データベースモデル定義と接続機能の実装完了
  - **現在: APIエンドポイント実装中**

### 次のフェーズ
- **実装フェーズ（継続）**
  - Slack連携の実装
  - データベース連携の実装
  - 自然言語処理モジュールの実装
  - スケジューラーの実装

## 最近の変更

### 設計フェーズ完了
- 要件定義書の作成
- ディレクトリ構成と依存関係ルールの定義
- API仕様書の作成
- DB仕様書の作成
- スケジューラー設計方針の策定
- テスト設計方針の策定
- ログ設計方針の策定
- 開発ワークフロー設計の策定
- 技術選定の確定
- 設定管理方針の策定
- 認証認可設計方針の策定
- CI/CD設計方針の策定

### マスタデータ準備
- アクティビティ種別マスタデータの作成
- 案件ステージマスタデータの作成

### 実装フェーズ
- プロジェクト構造のセットアップ
- 基本設定ファイルの実装（config.py、logger.py）
- データベースモデル定義の実装
- データベース接続機能の実装

### 最新の修正（feature/api-endpoints-implementation ブランチ）
- 通知サービスのテスト更新
- オーナー関係とユーザーモックの修正
- クエリの型を SelectOfScalar に変更し、関連するテストを調整
- UTCを使用して日時を取得するように修正
- ユーザーIDとオポチュニティIDの型変換を削除し、UUIDを直接使用するように修正
- pytest.iniの設定を更新し、DeprecationWarningを無視するフィルタを追加
- デバッグ設定の修正（launch.jsonのデバッグタイプ修正、settings.jsonの不要設定削除）

## 次のステップ

### 短期的なタスク
1. **APIエンドポイント定義の実装を完了する**
   - 通知サービス呼び出しの実装完了（TODOの対応）
   - エラーハンドリングの確認と強化

2. **CRUD操作用のサービス実装**
   - 未実装のサービスレイヤーの完成
   - ビジネスロジックの実装

3. **Slack連携の基本実装**
   - `slack/bot.py` の実装
     - Slackへのメッセージ送信機能
     - Slackユーザー情報取得機能
     - トークン管理・API制限対応
   - メッセージ送信機能の実装
   - ユーザー情報取得機能の実装

### Slack連携におけるファイル構成と責務
- `slack/handlers.py` - Slackからの**受信**処理（イベント処理、コマンド解析）
- `slack/bot.py` - Slackへの**送信**処理（メッセージ送信、ユーザー情報取得）
- `slack/models.py` - Slackデータ構造の定義

この構成により送受信の責務を明確に分離し、コードの保守性と再利用性を高める

### 中期的なタスク
1. **自然言語処理モジュールの実装**
   - agents/parser.py の実装
   - テキスト解析ロジックの実装

2. **スケジューラーの実装**
   - scheduler/task_runner.py の実装
   - 定期通知ロジックの実装

3. **テストの実装**
   - テスト環境のセットアップ
   - サービス層のテスト実装
   - OpenAPI仕様の整備とドキュメント改善

## アクティブな決定事項と考慮事項

### 決定済み事項
- FastAPIをバックエンドフレームワークとして採用
- PostgreSQLをデータベースとして採用
- SQLModelをORMとして採用
- APSchedulerをスケジューラーとして採用
- 依存関係ルールの確立（上位レイヤーから下位レイヤーのみ依存可）
- Slack署名検証による認証方式の採用
- UUIDを直接使用してIDを管理（型変換を廃止）
- UTCベースで日時を扱う方針
- API設計はdocs/API仕様.mdを最優先とする（実装とドキュメントの整合性を維持）

### 検討中の事項
- 自然言語処理の具体的な実装方法（OpenAI API vs 独自モデル）
- KPI通知ロジックの詳細設計
- 将来的な機械学習モデルの導入方針
- デプロイ環境の選定

## 学びとプロジェクトの洞察

### 重要なパターンと設計方針
- **レイヤードアーキテクチャ**の採用により、責務の分離と依存関係の明確化を実現
- **リポジトリパターン**によるデータアクセスの抽象化
- **依存性注入**によるテスト容易性の向上
- **イベント駆動型**のSlack連携処理
- **UUIDの直接使用**によるIDの型安全性確保
- **UTC日時の使用**によるタイムゾーン問題の回避
- **設計優先の原則**：設計ドキュメントを正とし、実装はそれに追従する

### プロジェクト固有の知見
- Slack Botを中心としたUI設計により、従来のWeb UIが不要に
- 自然言語入力による構造化データ変換が核となる機能
- ルールベースから機械学習ベースへの段階的な移行を想定した設計
- テストにおけるモックの重要性（特にユーザー関連とオーナー関係）
- コードは書いた瞬間から負債になるため、設計に基づいた必要最低限の実装を心がける
- ファイル名には役割を明確に反映させ、責務の範囲を明確化する

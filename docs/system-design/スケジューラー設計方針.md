
# スケジューラー設計方針

本ドキュメントは、営業オポチュニティマネジメント AIアシスタントシステムにおけるスケジューラー（定期通知機能）の設計方針を示す。

---

## 🎯 設計目的

- KPI達成に必要な行動を「促す」自動通知機能を提供
- 停滞しているオポチュニティを営業担当者にリマインド
- Slackを介した自然なコミュニケーション形式の実現

---

## ✅ 通知対象条件

以下の条件を満たすオポチュニティを通知対象とする：

1. オポチュニティが **クローズされていない**（進行中）
2. オポチュニティの **最終アクティビティ日が3日以上前**
3. 担当者（主担当 or 共同担当）に紐づいている

---

## ✅ 通知内容

Slackメッセージ例：

```
👀 あなたが担当している案件「株式会社ABC - クラウド移行」は、
3日間以上アクティビティが登録されていません。
ステージの更新や活動の記録を行いましょう！
```

### メッセージに含める情報：

- 担当オポチュニティのタイトル
- 顧客名
- 最終アクティビティ日
- Slackメンション

---

## ✅ 通知タイミング

| 項目           | 設定                                               |
| -------------- | -------------------------------------------------- |
| 実行タイミング | 毎日 09:00 JST                                     |
| 実行単位       | APScheduler cronジョブ                             |
| トリガーAPI    | `POST /notify/progress` エンドポイントを内部コール |

---

## ✅ 実行フロー

1. `opportunity` テーブルから未クローズ案件を取得
2. 各案件に対して最新の `activity_log` を検索
3. **最終アクティビティ日が3日以上前** の案件を抽出
4. `opportunity_user` から担当者リストを取得
5. 担当者ごとに案件リストを集計
6. 各担当者に対してSlackメッセージ送信

---

## ✅ 実装方針

- APSchedulerによるcronジョブで `/notify/progress` を定期実行
- `POST /notify/progress` ではSlack通知処理をサービス層に実装
- MLによる通知判定ロジックは後から内部ロジック差し替えで対応可能とする
- 通知条件は **設定ファイル or 定数定義** で管理

---

## ✅ 設計意図

- MVP段階ではルールベース（最終アクティビティから3日）を採用
- 将来的にML判定ロジックに置き換える際に、既存API・スケジューラー構造を変更せずに済むよう設計
- Slack通知はDM優先。未指定時はチャンネル通知 fallback を検討
- **通知が「迷惑」にならないよう、通知間隔・条件の調整は運用後に見直し可**

---

以上
